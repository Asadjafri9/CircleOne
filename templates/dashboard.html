{% extends "base.html" %}

{% block title %}Dashboard - CircleOne{% endblock %}

{% block content %}
<div class="dashboard">
    <div class="dashboard-header-enhanced">
        <div class="welcome-section">
            {% if user.profile_photo %}
            <img src="{{ user.profile_photo }}" alt="{{ user.name }}" class="dashboard-avatar">
            {% else %}
            <div class="dashboard-avatar-placeholder">{{ user.name[0].upper() }}</div>
            {% endif %}
            <div>
                <h1>Welcome back, {{ user.name }}! üëã</h1>
                <p class="dashboard-subtitle">Here's what's happening with your account</p>
            </div>
        </div>
        <div class="quick-actions">
            <a href="{{ url_for('create_business') }}" class="btn btn-primary">
                <span style="font-size: 1.2rem; margin-right: 4px;">+</span> Add Business
            </a>
            <a href="{{ url_for('edit_professional_profile') }}" class="btn btn-secondary">
                <span style="font-size: 1.2rem; margin-right: 4px;">üë§</span> Edit Profile
            </a>
        </div>
    </div>
    
    <!-- Statistics Overview -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <span style="font-size: 2rem;">üè¢</span>
            </div>
            <div class="stat-info">
                <h3>{{ user.businesses|length }}</h3>
                <p>Business{{ 'es' if user.businesses|length != 1 else '' }}</p>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                <span style="font-size: 2rem;">üëÅ</span>
            </div>
            <div class="stat-info">
                <h3>{{ user.businesses|sum(attribute='view_count') }}</h3>
                <p>Total Business Views</p>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                <span style="font-size: 2rem;">üíº</span>
            </div>
            <div class="stat-info">
                <h3>{{ user.professional_profile.view_count if user.professional_profile else 0 }}</h3>
                <p>Profile Views</p>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                <span style="font-size: 2rem;">üìÖ</span>
            </div>
            <div class="stat-info">
                <h3>{{ (user.created_at | string).split()[0] }}</h3>
                <p>Member Since</p>
            </div>
        </div>
    </div>
    
    <!-- Account Info -->
    <div class="dashboard-info-section">
        <h2 class="section-title">Account Information</h2>
        <div class="info-cards-grid">
            <div class="info-card">
                <div class="info-icon">üìß</div>
                <div class="info-content">
                    <label>Email</label>
                    <p>{{ user.email }}</p>
                </div>
            </div>
            
            <div class="info-card">
                <div class="info-icon">üîë</div>
                <div class="info-content">
                    <label>Login Provider</label>
                    <p>
                        <span class="provider-badge {{ user.oauth_provider }}">
                            {{ user.oauth_provider.title() }}
                        </span>
                    </p>
                </div>
            </div>
            
            <div class="info-card">
                <div class="info-icon">üé®</div>
                <div class="info-content">
                    <label>Theme</label>
                    <p id="current-theme-display">{{ user.theme_preference.title() }}</p>
                    <button class="btn btn-sm" onclick="toggleTheme()" style="margin-top: 0.5rem;">Toggle Theme</button>
                </div>
            </div>
        </div>
    </div>
    
    {% if user.profile_photo %}
    <div class="profile-photo-container">
        <h3>Profile Photo</h3>
        <img src="{{ user.profile_photo }}" alt="{{ user.name }}" class="profile-photo">
    </div>
    {% endif %}
    
    <!-- Business Listings Section -->
    <div class="dashboard-businesses">
        <div class="section-header">
            <h2>Your Business Listings</h2>
            <a href="{{ url_for('create_business') }}" class="btn btn-primary">+ Add Business</a>
        </div>
        
        {% if user.businesses %}
        <div class="businesses-list">
            {% for business in user.businesses %}
            <div class="business-item">
                <div class="business-item-info">
                    <h3><a href="{{ url_for('business_detail', id=business.id) }}">{{ business.business_name }}</a></h3>
                    <span class="business-category">{{ business.category }}</span>
                    <p class="business-stats">üëÅ {{ business.view_count }} views</p>
                </div>
                <div class="business-item-actions">
                    <a href="{{ url_for('business_detail', id=business.id) }}" class="btn btn-sm btn-primary">View</a>
                    <a href="{{ url_for('edit_business', id=business.id) }}" class="btn btn-sm btn-secondary">Edit</a>
                    <form method="POST" action="{{ url_for('delete_business', id=business.id) }}" style="display: inline;" onsubmit="return confirm('Delete {{ business.business_name }}?');">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                    </form>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="no-businesses">
            <p>You haven't created any business listings yet.</p>
            <a href="{{ url_for('create_business') }}" class="btn btn-primary">Create Your First Listing</a>
        </div>
        {% endif %}
    </div>
    
    <!-- Professional Profile Section -->
    <div class="dashboard-professionals">
        <div class="section-header">
            <h2>Your Professional Profile</h2>
            <a href="{{ url_for('edit_professional_profile') }}" class="btn btn-primary">
                {% if user.professional_profile %}Edit Profile{% else %}+ Create Profile{% endif %}
            </a>
        </div>
        
        {% if user.professional_profile %}
        <div class="professional-profile-card">
            <div class="profile-card-info">
                <h3>{{ user.professional_profile.job_title }}</h3>
                {% if user.professional_profile.consent_given %}
                <span class="status-badge status-public">‚úì Public</span>
                {% else %}
                <span class="status-badge status-private">üîí Private</span>
                {% endif %}
                <p class="profile-stats">üëÅ {{ user.professional_profile.view_count }} views</p>
                {% if user.professional_profile.get_skills() %}
                <div class="skills-preview-small">
                    {% for skill in user.professional_profile.get_skills()[:5] %}
                    <span class="skill-tag-small">{{ skill }}</span>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
            <div class="profile-card-actions">
                <a href="{{ url_for('professional_profile', id=user.professional_profile.id) }}" class="btn btn-sm btn-primary">View</a>
                <a href="{{ url_for('edit_professional_profile') }}" class="btn btn-sm btn-secondary">Edit</a>
                <form method="POST" action="{{ url_for('delete_professional_profile') }}" style="display: inline;" onsubmit="return confirm('Delete your professional profile?');">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                </form>
            </div>
        </div>
        {% else %}
        <div class="no-profile">
            <p>You haven't created a professional profile yet.</p>
            <p><small>Share your expertise and connect with others in the community.</small></p>
            <a href="{{ url_for('edit_professional_profile') }}" class="btn btn-primary">Create Your Profile</a>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Update theme display text on dashboard
    function updateThemeDisplay() {
        const currentTheme = document.documentElement.getAttribute('data-theme');
        const themeDisplay = document.getElementById('current-theme-display');
        if (themeDisplay) {
            themeDisplay.textContent = currentTheme.charAt(0).toUpperCase() + currentTheme.slice(1);
        }
    }
    
    // Override toggleTheme to also update the display
    (function() {
        const originalToggleTheme = window.toggleTheme;
        window.toggleTheme = function() {
            const result = originalToggleTheme();
            // Small delay to ensure theme attribute is updated
            setTimeout(updateThemeDisplay, 50);
            return result;
        };
    })();
    
    // Update display on page load
    document.addEventListener('DOMContentLoaded', function() {
        updateThemeDisplay();
    });
</script>
{% endblock %}
