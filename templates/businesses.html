{% extends "base.html" %}

{% block title %}Business Directory{% endblock %}

{% block content %}
<div class="businesses-page">
    <div class="page-header">
        <h1>Business Directory</h1>
        <p class="subtitle">Discover local businesses and services</p>
        {% if current_user.is_authenticated %}
        <a href="{{ url_for('create_business') }}" class="btn btn-primary">+ Add Your Business</a>
        {% endif %}
    </div>

    <!-- Search and Filter Section -->
    <div class="search-filter-section">
        <form method="GET" action="{{ url_for('businesses') }}" class="search-form">
            <div class="search-inputs">
                <input type="text" 
                       name="search" 
                       id="business-search"
                       placeholder="Search businesses..." 
                       value="{{ search }}"
                       class="search-input"
                       autocomplete="off">
                
                <select name="category" id="category-filter" class="filter-select">
                    <option value="">All Categories</option>
                    {% for cat in categories %}
                    <option value="{{ cat }}" {% if cat == selected_category %}selected{% endif %}>
                        {{ cat }}
                    </option>
                    {% endfor %}
                </select>
                
                <input type="text" 
                       name="location" 
                       id="location-filter"
                       placeholder="Location..." 
                       value="{{ selected_location }}"
                       class="location-input"
                       autocomplete="off">
                
                <button type="submit" class="btn btn-primary">Search</button>
                <a href="{{ url_for('businesses') }}" class="btn btn-secondary">Clear</a>
            </div>
        </form>
    </div>

    <!-- Results Count -->
    <div class="results-info">
        <p>Found {{ listings|length }} business{{ 'es' if listings|length != 1 else '' }}</p>
    </div>

    <!-- Business Listings Grid -->
    <div class="businesses-grid">
        {% if listings %}
            {% for business in listings %}
            <div class="business-card" 
                 data-category="{{ business.category.lower() }}"
                 data-location="{{ business.location.lower() if business.location else '' }}"
                 data-name="{{ business.business_name.lower() }}"
                 data-description="{{ business.description.lower() if business.description else '' }}">
                <a href="{{ url_for('business_detail', id=business.id) }}" class="business-card-link">
                    {% if business.logo_url %}
                    <div class="business-logo">
                        <img src="{{ business.logo_url }}" alt="{{ business.business_name }}">
                    </div>
                    {% else %}
                    <div class="business-logo-placeholder">
                        {{ business.business_name[0].upper() }}
                    </div>
                    {% endif %}
                    
                    <div class="business-info">
                        <h3>{{ business.business_name }}</h3>
                        <span class="business-category">{{ business.category }}</span>
                        
                        {% if business.location %}
                        <p class="business-location">üìç {{ business.location }}</p>
                        {% endif %}
                        
                        {% if business.description %}
                        <p class="business-description">
                            {{ business.description[:150] }}{% if business.description|length > 150 %}...{% endif %}
                        </p>
                        {% endif %}
                        
                        <div class="business-meta">
                            <span class="view-count">üëÅ {{ business.view_count }} views</span>
                            <span class="business-date">{{ business.created_at.strftime('%b %d, %Y') }}</span>
                        </div>
                    </div>
                </a>
            </div>
            {% endfor %}
        {% else %}
            <div class="no-results">
                <h3>No businesses found</h3>
                <p>Try adjusting your search criteria or be the first to add a business!</p>
                {% if current_user.is_authenticated %}
                <a href="{{ url_for('create_business') }}" class="btn btn-primary">Add Your Business</a>
                {% endif %}
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/search.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize instant search
    const businessSearch = new DirectorySearch(
        '.businesses-page',
        '.businesses-grid',
        '#business-search',
        ['#category-filter', '#location-filter']
    );
    
    // Add clear all button functionality
    const clearButton = document.querySelector('a[href*="businesses"]:not([href*="create"])');
    if (clearButton) {
        clearButton.addEventListener('click', function(e) {
            e.preventDefault();
            businessSearch.clearFilters();
            window.history.pushState({}, '', '{{ url_for("businesses") }}');
        });
    }
    
    // Extract business names for autocomplete
    const businessNames = [];
    document.querySelectorAll('.business-card').forEach(card => {
        const name = card.dataset.name;
        if (name) businessNames.push(name);
    });
    
    // Initialize autocomplete if we have data
    if (businessNames.length > 0) {
        new SearchAutocomplete('#business-search', businessNames);
    }
});
</script>
{% endblock %}
